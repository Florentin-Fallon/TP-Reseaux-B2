# TP2 : Environnement virtuel #

# I. Topologie réseau #

# Compte-rendu

* Carte Résaux :

```
[florentinfallon@node2 ~]$ ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: enp0s1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 06:fb:d3:c5:58:7f brd ff:ff:ff:ff:ff:ff
    inet 10.1.1.11/24 brd 10.1.1.255 scope global noprefixroute enp0s1
       valid_lft forever preferred_lft forever
    inet6 fe80::4fb:d3ff:fec5:587f/64 scope link 
       valid_lft forever preferred_lft forever
```

* Table de routage :

```
[florentinfallon@node2 ~]$ ip route show
default via 10.1.1.254 dev enp0s1 proto static metric 100 
10.1.1.0/24 dev enp0s1 proto kernel scope link src 10.1.1.11 metric 100 
10.1.2.0 via 10.1.1.254 dev enp0s1 proto static metric 100 
```

* Joindre node2.lan2.tp2

```
[florentinfallon@node2 ~]$ ping 10.1.2.12
PING 10.1.2.12 (10.1.2.12) 56(84) bytes of data.
64 bytes from 10.1.2.12: icmp_seq=1 ttl=63 time=3.15 ms
64 bytes from 10.1.2.12: icmp_seq=2 ttl=63 time=3.46 ms
^C
--- 10.1.2.12 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1002ms
rtt min/avg/max/mdev = 3.146/3.305/3.464/0.159 ms
```

* Traceroute :

```
[florentinfallon@node2 ~]$ traceroute 10.1.2.12
traceroute to 10.1.2.12 (10.1.2.12), 30 hops max, 60 byte packets
 1  _gateway (10.1.1.254)  1.666 ms  1.393 ms  1.823 ms
 2  10.1.2.12 (10.1.2.12)  6.091 ms !X  6.044 ms !X  6.003 ms !X
```
# II. Interlude accès internet #

# ☀️ Sur router.tp2

* Acces Internet :

```
[florentinfallon@router ~]$ ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=114 time=20.3 ms
64 bytes from 8.8.8.8: icmp_seq=2 ttl=114 time=29.0 ms
64 bytes from 8.8.8.8: icmp_seq=3 ttl=114 time=24.0 ms
^C
--- 8.8.8.8 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2005ms
rtt min/avg/max/mdev = 20.303/24.451/29.040/3.580 ms
```

* Ping Nom de Domaine :

```
[florentinfallon@router ~]$ ping ynov.com
PING ynov.com (104.26.11.233) 56(84) bytes of data.
64 bytes from 104.26.11.233 (104.26.11.233): icmp_seq=1 ttl=56 time=14.2 ms
64 bytes from 104.26.11.233 (104.26.11.233): icmp_seq=2 ttl=56 time=24.5 ms
64 bytes from 104.26.11.233 (104.26.11.233): icmp_seq=3 ttl=56 time=24.1 ms
^C
--- ynov.com ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2005ms
rtt min/avg/max/mdev = 14.232/20.971/24.549/4.768 ms
```

# ☀️ Accès internet LAN1 et LAN2

* Route par défault LAN1 :

```
[florentinfallon@node2 ~]$ cat /etc/sysconfig/network
# Created by anaconda
GATEWAY=10.1.1.254
```

* Route par défault LAN2 :

```
[florentinfallon@node1 ~]$ cat /etc/sysconfig/network
# Created by anaconda
GATEWAY=10.1.2.12
```
* Serveur DNS :

```
[florentinfallon@node2 ~]$ sudo cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
```
* dig gitlab.com

```
[florentinfallon@node2 ~]$ dig gitlab.com

; <<>> DiG 9.16.23-RH <<>> gitlab.com
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 11053
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
;; QUESTION SECTION:
;gitlab.com.			IN	A

;; ANSWER SECTION:
gitlab.com.		252	IN	A	172.65.251.78

;; Query time: 20 msec
;; SERVER: 1.1.1.1#53(1.1.1.1)
;; WHEN: Wed Oct 25 11:42:49 CEST 2023
;; MSG SIZE  rcvd: 55


```

* Ping IP Public :

```
[florentinfallon@node2 ~]$ ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=113 time=29.8 ms
64 bytes from 8.8.8.8: icmp_seq=2 ttl=113 time=25.0 ms
64 bytes from 8.8.8.8: icmp_seq=3 ttl=113 time=31.0 ms
^C
--- 8.8.8.8 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2007ms
rtt min/avg/max/mdev = 24.964/28.569/30.993/2.599 ms
```

* Ping Nom de Domaine :

```
[florentinfallon@node2 ~]$ ping ynov.com
PING ynov.com (104.26.11.233) 56(84) bytes of data.
64 bytes from 104.26.11.233 (104.26.11.233): icmp_seq=1 ttl=55 time=17.4 ms
64 bytes from 104.26.11.233 (104.26.11.233): icmp_seq=2 ttl=55 time=27.5 ms
^C
--- ynov.com ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1001ms
rtt min/avg/max/mdev = 17.399/22.472/27.545/5.073 ms
```
# III. Services réseau #
# 1. DHCP #
# ☀️ Sur dhcp.lan1.tp2

* Rename :

```
[florentinfallon@dhcp ~]$ sudo cat /etc/hostname
[sudo] password for florentinfallon: 
dhcp.lan1.tp2
```

* Changer son IP :

```
[florentinfallon@dhcp ~]$ sudo cat /etc/sysconfig/network-scripts/ifcfg-enp0s1 
DEVICE=enp0s1

BOOTPROTO=static
ONBOOT=yes

IPADDR=10.1.1.253
NETMASK=255.255.255.0
```

* Setup DHCP :

```
[florentinfallon@dhcp ~]$ sudo dnf -y install dhcp-server
Installed:
  dhcp-common-12:4.4.2-18.b1.el9.noarch  dhcp-server-12:4.4.2-18.b1.el9.aarch64 

Complete!
```

* Fichier de conf :

```
[florentinfallon@dhcp ~]$ sudo cat /etc/dhcp/dhcpd.conf
#
# DHCP Server Configuration file.
#   see /usr/share/doc/dhcp-server/dhcpd.conf.example
#   see dhcpd.conf(5) man page
#
# this DHCP server to be declared valid
authoritative;

# specify network address and subnetmask
subnet 10.1.1.0 netmask 255.255.255.0 {
    # specify the range of lease IP address
    range dynamic-bootp 10.1.1.100 10.1.1.200;
    # specify broadcast address
    option broadcast-address 10.1.1.255;
    # specify gateway
    option routers 10.1.1.254;
}
```

* Service Actif :

```
[florentinfallon@dhcp ~]$ sudo systemctl status dhcpd
● dhcpd.service - DHCPv4 Server Daemon
     Loaded: loaded (/usr/lib/systemd/system/dhcpd.service; enabled; preset: disabled)
     Active: active (running) since Wed 2023-10-25 12:09:58 CEST; 2min 13s ago
       Docs: man:dhcpd(8)
             man:dhcpd.conf(5)
   Main PID: 2040 (dhcpd)
     Status: "Dispatching packets..."
      Tasks: 1 (limit: 22704)
     Memory: 4.5M
        CPU: 6ms
     CGroup: /system.slice/dhcpd.service
             └─2040 /usr/sbin/dhcpd -f -cf /etc/dhcp/dhcpd.conf -user dhcpd -group dhcpd --no-pid

Oct 25 12:09:57 dhcp.lan1.tp2 dhcpd[2040]: Config file: /etc/dhcp/dhcpd.conf
Oct 25 12:09:57 dhcp.lan1.tp2 dhcpd[2040]: Database file: /var/lib/dhcpd/dhcpd.leases
Oct 25 12:09:57 dhcp.lan1.tp2 dhcpd[2040]: PID file: /var/run/dhcpd.pid
Oct 25 12:09:57 dhcp.lan1.tp2 dhcpd[2040]: Source compiled to use binary-leases
Oct 25 12:09:57 dhcp.lan1.tp2 dhcpd[2040]: Wrote 0 leases to leases file.
Oct 25 12:09:58 dhcp.lan1.tp2 dhcpd[2040]: Listening on LPF/enp0s1/86:a9:8d:c8:f3:2d/10.1.1.0/24
Oct 25 12:09:58 dhcp.lan1.tp2 dhcpd[2040]: Sending on   LPF/enp0s1/86:a9:8d:c8:f3:2d/10.1.1.0/24
Oct 25 12:09:58 dhcp.lan1.tp2 systemd[1]: Started DHCPv4 Server Daemon.
Oct 25 12:09:58 dhcp.lan1.tp2 dhcpd[2040]: Sending on   Socket/fallback/fallback-net
Oct 25 12:09:58 dhcp.lan1.tp2 dhcpd[2040]: Server starting service.
```

# ☀️ Sur node1.lan1.tp2

* Demande IP au serveur DHCP :

```
[florentinfallon@node1 ~]$ ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: enp0s1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 06:fb:d3:c5:58:7f brd ff:ff:ff:ff:ff:ff
    inet 192.168.29.9/24 brd 192.168.29.255 scope global dynamic noprefixroute enp0s1
       valid_lft 86337sec preferred_lft 86337sec
    inet 10.1.1.100/24 brd 10.1.1.255 scope global dynamic noprefixroute enp0s1
       valid_lft 43153sec preferred_lft 43153sec
    inet6 fe80::4fb:d3ff:fec5:587f/64 scope link 
       valid_lft forever preferred_lft forever
```

* ping node1.lan2.tp2

```
[florentinfallon@node1 ~]$ ping 10.1.2.11
PING 10.1.2.11 (10.1.2.11) 56(84) bytes of data.
64 bytes from 10.1.2.11: icmp_seq=1 ttl=63 time=3.19 ms
64 bytes from 10.1.2.11: icmp_seq=2 ttl=63 time=3.11 ms
^C
--- 10.1.2.11 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1003ms
rtt min/avg/max/mdev = 3.112/3.150/3.189/0.038 ms

```

# 2. Web web web #

* Setup du service web :

```
[florentinfallon@node2 ~]$ sudo dnf install nginx
Installed:
  nginx-1:1.20.1-14.el9_2.1.aarch64                                             
  nginx-core-1:1.20.1-14.el9_2.1.aarch64                                        
  nginx-filesystem-1:1.20.1-14.el9_2.1.noarch                                   
  rocky-logos-httpd-90.14-1.el9.noarch                                          

Complete!
```

* Configuration :

```
[florentinfallon@node2 site_nul]$ cat index.html 
# For more information on configuration, see:
#   * Official English Documentation: http://nginx.org/en/docs/
#   * Official Russian Documentation: http://nginx.org/ru/docs/

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

# Load dynamic modules. See /usr/share/doc/nginx/README.dynamic.
include /usr/share/nginx/modules/*.conf;

events {
    worker_connections 1024;
}

http {
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 4096;

    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;

    # Load modular configuration files from the /etc/nginx/conf.d directory.
    # See http://nginx.org/en/docs/ngx_core_module.html#include
    # for more information.
    include /etc/nginx/conf.d/*.conf;

    server {
        listen       80;
        listen       [::]:80;
        server_name  _;
        root         /var/www/site_nul;

        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;

        error_page 404 /404.html;
        location = /404.html {
        }

        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
        }
    }

# Settings for a TLS enabled server.
#
#    server {
#        listen       443 ssl http2;
#        listen       [::]:443 ssl http2;
#        server_name  _;
#        root         /usr/share/nginx/html;
#
#        ssl_certificate "/etc/pki/nginx/server.crt";
#        ssl_certificate_key "/etc/pki/nginx/private/server.key";
#        ssl_session_cache shared:SSL:1m;
#        ssl_session_timeout  10m;
#        ssl_ciphers PROFILE=SYSTEM;
#        ssl_prefer_server_ciphers on;
#
#        # Load configuration files for the default server block.
#        include /etc/nginx/default.d/*.conf;
#
#        error_page 404 /404.html;
#            location = /40x.html {
#        }
#
#        error_page 500 502 503 504 /50x.html;
#            location = /50x.html {
#        }
#    }

}
```

* Service actif :

```
[florentinfallon@node2 site_nul]$ sudo systemctl status nginx
● nginx.service - The nginx HTTP and reverse proxy server
     Loaded: loaded (/usr/lib/systemd/system/nginx.service; enabled; preset: di>
     Active: active (running) since Wed 2023-10-25 13:02:20 CEST; 7s ago
    Process: 1837 ExecStartPre=/usr/bin/rm -f /run/nginx.pid (code=exited, stat>
    Process: 1838 ExecStartPre=/usr/sbin/nginx -t (code=exited, status=0/SUCCES>
    Process: 1839 ExecStart=/usr/sbin/nginx (code=exited, status=0/SUCCESS)
   Main PID: 1840 (nginx)
      Tasks: 5 (limit: 22704)
     Memory: 4.5M
        CPU: 20ms
     CGroup: /system.slice/nginx.service
             ├─1840 "nginx: master process /usr/sbin/nginx"
             ├─1841 "nginx: worker process"
             ├─1842 "nginx: worker process"
             ├─1843 "nginx: worker process"
             └─1844 "nginx: worker process"

Oct 25 13:02:20 web.lan2.tp2 systemd[1]: Starting The nginx HTTP and reverse pr>
Oct 25 13:02:20 web.lan2.tp2 nginx[1838]: nginx: the configuration file /etc/ng>
Oct 25 13:02:20 web.lan2.tp2 nginx[1838]: nginx: configuration file /etc/nginx/>
Oct 25 13:02:20 web.lan2.tp2 systemd[1]: Started The nginx HTTP and reverse proxy server.
```

* Ouverture du port firewall :

```
[florentinfallon@node2 site_nul]$ sudo firewall-cmd --zone=public --add-port=80/tcp
Warning: ALREADY_ENABLED: '80:tcp' already in 'public'
success
```

* Programme nginx qui troune sur le port 80 :

```
[florentinfallon@node2 site_nul]$ ss -lapute || grep http
tcp          LISTEN        0             511                        0.0.0.0:http                    0.0.0.0:*            ino:24035 sk:4 cgroup:/system.slice/nginx.service <->  
tcp          LISTEN        0             511                           [::]:http                       [::]:*            ino:24036 sk:7 cgroup:/system.slice/nginx.service v6only:1 <->   
```

* Firewall bien configuré :

```
[florentinfallon@node2 site_nul]$ sudo firewall-cmd --zone=public --list-all || grep ports
 ports: 80/tcp
```

* Visite du site :

```
[florentinfallon@node2 site_nul]$ curl site_nul.tp2
<!doctype html>
<html>
  <head>
    <meta charset='utf-8'>
     <body>
    <h2>Just visiting?</h2>
     </body>
</html>
```